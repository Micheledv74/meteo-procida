const data = $input.first().json;

// Helper function per le icone meteo
function getWeatherIcon(code) {
  const icons = {
    0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
    45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
    51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è',
    61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
    71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
    80: 'üå¶Ô∏è', 81: 'üåßÔ∏è', 82: '‚õàÔ∏è',
    95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
  };
  return icons[code] || 'üå§Ô∏è';
}

// Helper function per i nomi dei giorni abbreviati
function getDayName(date) {
  const days = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
  const d = new Date(date);
  return days[d.getDay()];
}

// Genera le card per i prossimi 7 giorni
let weekForecast = '';
data.daily.forEach((day, index) => {
  const isToday = index === 0;
  const aiSection = isToday && day.ai_analysis ? `
    <div class="ai-section">
      <h3>üìä Analisi AI</h3>
      <p class="summary">${day.ai_analysis.summary}</p>
      
      <h4>üí° Consigli:</h4>
      <ul class="advice">
        ${day.ai_analysis.advice.map(a => `<li>${a}</li>`).join('')}
      </ul>
      
      ${day.ai_analysis.alerts && day.ai_analysis.alerts.length > 0 ? `
        <h4>‚ö†Ô∏è Allerte:</h4>
        ${day.ai_analysis.alerts.map(alert => `
          <div class="alert alert-${alert.severity.toLowerCase()}">
            <strong>${alert.type}</strong>: ${alert.description}
          </div>
        `).join('')}
      ` : ''}
    </div>
  ` : '';

  weekForecast += `
    <div class="day-card ${isToday ? 'today' : ''}">
      <div class="day-header">
        <h3>${isToday ? 'OGGI' : getDayName(day.date)} ${day.date.split('-')[2]}/${day.date.split('-')[1]}</h3>
        <div class="weather-icon">${getWeatherIcon(day.weather_code)}</div>
      </div>
      
      <div class="day-info">
        <div class="temp-range">
          <span class="temp-max">${day.temp_max}¬∞</span>
          <span class="temp-min">${day.temp_min}¬∞</span>
        </div>
        
        <div class="weather-details">
          <div class="detail">üíß Pioggia: ${day.precipitation_sum}mm (${day.precipitation_probability_max}%)</div>
          <div class="detail">üí® Vento: ${day.wind_speed_max} km/h (raffiche ${day.wind_gusts_max} km/h)</div>
          <div class="detail">üåä Onde: ${day.wave_height_max}m - ${day.sea_state}</div>
          <div class="detail">‚òÄÔ∏è UV: ${day.uv_index_max}</div>
        </div>
        
        <div class="sea-badge ${day.sea_severity.toLowerCase()}">${day.sea_severity}</div>
      </div>
      
      ${aiSection}
    </div>
  `;
});

// HTML completo
const html = `<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meteo Procida - 7 Giorni</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      background: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .update-time {
      color: #666;
      font-size: 0.9em;
    }
    
    .week-stats {
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .stat-box {
      text-align: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .stat-label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
    .stat-value { font-size: 1.5em; font-weight: bold; color: #667eea; }
    
    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .day-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .day-card:hover { transform: translateY(-5px); }
    
    .day-card.today {
      border: 3px solid #667eea;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .day-header h3 { color: #667eea; font-size: 1.3em; }
    .weather-icon { font-size: 2.5em; }
    
    .temp-range {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 1.8em;
    }
    
    .temp-max { color: #ff6b6b; font-weight: bold; }
    .temp-min { color: #4ecdc4; }
    
    .weather-details {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .detail {
      padding: 5px 0;
      font-size: 0.95em;
    }
    
    .sea-badge {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9em;
      margin-top: 10px;
    }
    
    .sea-badge.verde { background: #51cf66; color: white; }
    .sea-badge.gialla { background: #ffd43b; color: #333; }
    .sea-badge.arancione { background: #ff922b; color: white; }
    .sea-badge.rossa { background: #ff6b6b; color: white; }
    
    .ai-section {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea15, #764ba215);
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    
    .ai-section h3 { color: #667eea; margin-bottom: 10px; }
    .ai-section h4 { color: #764ba2; margin: 15px 0 10px; font-size: 1em; }
    
    .summary {
      line-height: 1.6;
      margin-bottom: 15px;
      color: #555;
    }
    
    .advice {
      list-style: none;
      padding: 0;
    }
    
    .advice li {
      padding: 8px 0 8px 25px;
      position: relative;
      color: #555;
    }
    
    .advice li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: #51cf66;
      font-weight: bold;
    }
    
    .alert {
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .alert-verde { background: #51cf6620; border-left: 4px solid #51cf66; }
    .alert-gialla { background: #ffd43b20; border-left: 4px solid #ffd43b; }
    .alert-arancione { background: #ff922b20; border-left: 4px solid #ff922b; }
    .alert-rossa { background: #ff6b6b20; border-left: 4px solid #ff6b6b; }
    
    footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: white;
      font-size: 0.9em;
    }
    
    @media (max-width: 768px) {
      .forecast-grid { grid-template-columns: 1fr; }
      h1 { font-size: 1.8em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üåä Meteo Procida</h1>
      <p class="update-time">Aggiornato: ${new Date().toLocaleString('it-IT', { timeZone: 'Europe/Rome' })}</p>

    </header>
    
    <div class="week-stats">
      <div class="stat-box">
        <div class="stat-label">Temp. Media Max</div>
        <div class="stat-value">${data.weekly_stats.temp_max_avg}¬∞C</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Temp. Media Min</div>
        <div class="stat-value">${data.weekly_stats.temp_min_avg}¬∞C</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Pioggia Totale</div>
        <div class="stat-value">${data.weekly_stats.precipitation_total}mm</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Giorni di Pioggia</div>
        <div class="stat-value">${data.weekly_stats.rainy_days}</div>
      </div>
    </div>
    
    <div class="forecast-grid">
      ${weekForecast}
    </div>
    
    <footer>
      <p>Dati da Open-Meteo ‚Ä¢ Analisi AI powered by Groq ‚Ä¢ ${data.location.moon_phase} üåô</p>
      <p>Pressione atmosferica: ${data.pressure_trend}</p>
    </footer>
  </div>
</body>
</html>`;

return {
  json: {
    html: html,
    weather_data: data
  }
};
